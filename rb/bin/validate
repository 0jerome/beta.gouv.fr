#!/usr/bin/env ruby

require 'rubygems'
require 'bundler'
Bundler.setup :test

require 'kwalify'
require 'yaml'
require 'rake'

schema_path = ARGV[0]
schema      = Kwalify::Yaml.load_file(schema_path)
validator   = Kwalify::Validator.new(schema)
list_path   = ARGV[1]
list        = Rake::FileList[list_path]

puts "Running #{schema_path} on #{list_path}"

errors = list.each_with_object({}) do |file_path, list_errors|
  file                   = Kwalify::Yaml.load_file(file_path)
  file_errors            = validator.validate(file)
  list_errors[file_path] = file_errors if file_errors && !file_errors.empty?
end

puts "Run on #{list.count} files...\n"

if errors.empty?
  puts 'All good!'
else
  errors.each do |file_path, file_errors|
    file_errors.each do |error|
      puts "Error in #{file_path}: [#{error.path}] #{error.message}"
    end
  end

  exit 1
end
